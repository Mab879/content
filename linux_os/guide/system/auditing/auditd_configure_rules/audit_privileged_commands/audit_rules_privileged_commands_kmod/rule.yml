{{%- if product in ["rhel8", "rhel9"] %}}
    {{%- set kmod_audit="-a always,exit -F path=/usr/bin/kmod -F perm=x -F auid>=1000 -F auid!=unset -F key=privileged" %}}
{{%- elif product in ["rhel7"] %}}
    {{%- set kmod_audit="-w /usr/bin/kmod -p x -F auid!=unset -k module-change" %}}
{{%- elif product in ["ubuntu2004", "ubuntu2204"] %}}
    {{%- set kmod_audit="-w /bin/kmod -p x -k modules" %}}
{{%- elif product in ["ol7"] %}}
    {{%- set kmod_audit="-w /usr/bin/kmod -p x -F auid!=unset -k modules" %}}
{{%- else %}}
    {{%- set kmod_audit="-w /usr/bin/kmod -p x -k modules" %}}
{{%- endif %}}

documentation_complete: true

prodtype: ol7,ol8,ol9,rhel7,rhel8,rhel9,sle12,sle15,ubuntu2004,ubuntu2204

title: 'Ensure auditd Collects Information on the Use of Privileged Commands - kmod'

description: |-
    At a minimum, the audit system should collect the execution of
    privileged commands for all users and root. If the <tt>auditd</tt> daemon is
    configured to use the <tt>augenrules</tt> program to read audit rules during
    daemon startup (the default), add a line of the following form to a file with
    suffix <tt>.rules</tt> in the directory <tt>/etc/audit/rules.d</tt>:
    <pre>{{{ kmod_audit }}}</pre>
    If the <tt>auditd</tt> daemon is configured to use the <tt>auditctl</tt>
    utility to read audit rules during daemon startup, add a line of the following
    form to <tt>/etc/audit/audit.rules</tt>:
    <pre>{{{ kmod_audit }}}</pre>

rationale: |-
    Without generating audit records that are specific to the security and
    mission needs of the organization, it would be difficult to establish,
    correlate, and investigate the events relating to an incident or identify
    those responsible for one.

    Audit records can be generated from various components within the
    information system (e.g., module or policy filter).

severity: medium

identifiers:
    cce@rhel7: CCE-86110-4
    cce@rhel8: CCE-89455-0
    cce@rhel9: CCE-90262-7
    cce@sle12: CCE-83207-1
    cce@sle15: CCE-85591-6

references:
    disa: CCI-000130,CCI-000135,CCI-000169,CCI-000172,CCI-002884
    nist: AU-3,AU-3.1,AU-12(a),AU-12.1(ii),AU-12.1(iv)AU-12(c),MA-4(1)(a)
    srg: SRG-OS-000037-GPOS-00015,SRG-OS-000042-GPOS-00020,SRG-OS-000062-GPOS-00031,SRG-OS-000392-GPOS-00172,SRG-OS-000462-GPOS-00206,SRG-OS-000471-GPOS-00215,SRG-OS-000471-GPOS-00216,SRG-OS-000477-GPOS-00222
    stigid@ol7: OL07-00-030840
    stigid@ol8: OL08-00-030580
    stigid@rhel7: RHEL-07-030840
    stigid@rhel8: RHEL-08-030580
    stigid@sle12: SLES-12-020360
    stigid@sle15: SLES-15-030410
    stigid@ubuntu2004: UBTU-20-010297

{{{ ocil_fix_srg_privileged_command("kmod") }}}

platform: machine

template:
    name: audit_rules_privileged_commands
    vars:
        path: /usr/bin/kmod
        path@ubuntu2004: /bin/kmod

srg_requirement: |-
    {{{ full_name }}} must audit all uses of the kmod command.

vuldiscussion: |-
    Without the capability to generate audit records, it would be difficult to establish, correlate, and investigate the events relating to an incident or identify those responsible for one.

    Audit records can be generated from various components within the information system (e.g., module or policy filter).

    The list of audited events is the set of events for which audits are to be generated. This set of events is typically a subset of the list of all events for which the system is capable of generating audit records.

    DoD has defined the list of events for which the operating system will provide an audit record generation capability as the following:

    1) Successful and unsuccessful attempts to access, modify, or delete privileges, security objects, security levels, or categories of information (e.g., classification levels);

    2) Access actions, such as successful and unsuccessful logon attempts, privileged activities or other system-level access, starting and ending time for user access to the system, concurrent logons from different workstations, successful and unsuccessful accesses to objects, all program initiations, and all direct access to the information system;

    3) All account creations, modifications, disabling, and terminations; and

    4) All kernel module load, unload, and restart actions.

checktext: |-
    Verify that {{{ full_name }}} is configured to audit the execution of the "kmod" command with the following command:

    $ sudo auditctl -l | grep kmod

    -a always,exit -F path=/usr/bin/kmod -F perm=x -F auid>=1000 -F auid!=unset -k modules

    If the command does not return a line, or the line is commented out, this is a finding.

fixtext: |-
    Configure {{{ full_name }}} to generate audit records upon successful/unsuccessful attempts to use the "kmod" command by adding or updating the following rule in "/etc/audit/rules.d/audit.rules":

    -a always,exit -F path=/usr/bin/kmod -F perm=x -F auid>=1000 -F auid!=unset -k modules

    The audit daemon must be restarted for the changes to take effect.
